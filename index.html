<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤±ç‰©æ‰¾å›å¹³å° - æ°¸æ…•æ™ºåˆ›è½¯ä»¶å·¥ä½œå®¤</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #333;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #f5f5f5;
            --warning-bg: #2d1a1c;
            --notice-bg: #2d2a1a;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            margin-top: 15px;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 22px;
        }
        .notice {
            background-color: var(--notice-bg);
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            border-radius: 5px;
        }
        .warning {
            background-color: var(--warning-bg);
            border-left: 4px solid #f44336;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            border-radius: 5px;
        }
        .contact-info {
            margin-bottom: 25px;
        }
        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background-color: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
        }
        .contact-icon {
            width: 35px;
            height: 35px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 12px;
            font-size: 18px;
        }
        .contact-detail h3 {
            color: var(--primary-color);
            margin-bottom: 3px;
            font-size: 15px;
        }
        .contact-detail p {
            color: #ccc;
            font-size: 13px;
        }
        .location-display {
            margin-top: 15px;
            padding: 12px;
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4caf50;
            font-size: 13px;
            border-radius: 5px;
        }
        .error-message {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid #f44336;
            font-size: 12px;
            color: #ff9e9e;
            border-radius: 5px;
            display: none;
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 11px;
            color: #999;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 18px;
            }
        }
        .submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-size: 14px;
        }
        .submit-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            background-color: rgba(255,255,255,0.05);
            border: 1px solid #444;
            color: var(--text-color);
            border-radius: 5px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ°¸æ…•æ™ºåˆ›è½¯ä»¶å·¥ä½œå®¤å¤±ç‰©æ‰¾å›å¹³å°</h1>
        
        <div class="notice">
            æ‚¨æ‰«æäº†å¸¦æœ‰å¤±ç‰©æ‰¾å›æœåŠ¡çš„äºŒç»´ç ï¼Œæœ¬å¹³å°å°†ååŠ©æ‚¨è”ç³»å¤±ä¸»ã€‚<br>
            éœ€è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯ä»¥é€šçŸ¥å¤±ä¸»ï¼Œè¯·ç¡®ä¿å·²å¼€å¯å®šä½æœåŠ¡ã€‚<br>
            âš ï¸é¦–æ¬¡è®¿é—®å°†å¼¹çª—ç”³è¯·å®šä½æƒé™ï¼Œè¯·ç‚¹å‡»å…è®¸ï¼<br>
            ã€æ ¹æ®æ³•å¾‹è§„å®šï¼šæ‚¨çš„éšç§æ•°æ®å°†åœ¨å¤±ç‰©å½’è¿˜åæ°¸ä¹…åˆ é™¤ã€‘
        </div>

        <div class="form-group">
            <label for="item-name">å¤±ç‰©åç§°</label>
            <input type="text" id="item-name" placeholder="è¯·è¾“å…¥å¤±ç‰©åç§°" required>
        </div>

        <div class="form-group">
            <label for="finder-name">æ‹¾å–è€…å§“åï¼ˆé€‰å¡«ï¼‰</label>
            <input type="text" id="finder-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
        </div>

        <div class="form-group">
            <label for="finder-phone">è”ç³»ç”µè¯ï¼ˆé€‰å¡«ï¼‰</label>
            <input type="tel" id="finder-phone" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”µè¯">
        </div>

        <button class="submit-btn" id="submit-btn">æäº¤ä½ç½®ä¿¡æ¯</button>

        <div class="location-display" id="location-info" style="display: none;">
            <h3>ä½ç½®ä¿¡æ¯</h3>
            <p>æ‚¨çš„ä½ç½®ï¼š<span id="user-location">æ­£åœ¨è·å–...</span></p>
            <p>è¯¦ç»†åœ°å€ï¼š<span id="user-address">æ­£åœ¨è·å–...</span></p>
            <p>æˆ‘ä»¬å·²è®°å½•æ­¤ä¿¡æ¯å¹¶é€šçŸ¥å¤±ä¸»ï¼Œè¯·é€šè¿‡ä¸Šæ–¹è”ç³»æ–¹å¼è”ç³»å¤±ä¸»ã€‚</p>
            <div class="error-message" id="error-message"></div>
        </div>

        <div class="warning">
            <h3>é‡è¦è­¦ç¤º</h3>
            <p>âš ï¸ä½ç½®ä¿¡æ¯å°†è¢«è®°å½•ï¼Œè¯·åŠæ—¶è”ç³»å¤±ä¸»ï¼</p>
            <p>å¦‚æœªåŠæ—¶è”ç³»ï¼Œå¤±ä¸»å¯æŠ¥æ¡ˆå¤„ç†ï¼Œåæœè‡ªè´Ÿã€‚</p>
        </div>

        <div class="footer">
            å»ºè®¾è¿è¥ï¼šæ°¸æ…•æ™ºåˆ›è½¯ä»¶å·¥ä½œå®¤<br>
            æŠ€æœ¯æ”¯æŒï¼šé«˜å¾·åœ°å›¾ã€ä¼ä¸šå¾®ä¿¡
        </div>
    </div>

    <!-- é«˜å¾·åœ°å›¾å®‰å…¨é…ç½® -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "6655b8ddcef38eb7dcfc6b4ec649cedd", // æ›¿æ¢ä¸ºå®é™…å®‰å…¨å¯†é’¥
        };
    </script>

    <!-- é«˜å¾·åœ°å›¾APIåŠ è½½ -->
    <script 
        type="text/javascript" 
        src="https://webapi.amap.com/maps?v=2.0&key=197ddb697c7ee953ddd1e0472d95b201&plugin=AMap.Geolocation,AMap.Geocoder">
    </script>

    <script>
        // åˆå§‹åŒ–æç¤º
        alert("æ‚¨å·²è¿›å…¥å¤±ç‰©æ‰¾å›å¹³å°ï¼Œéœ€è·å–ä½ç½®ä¿¡æ¯ä»¥é€šçŸ¥å¤±ä¸»ã€‚\nè¯·ç¡®ä¿å·²å¼€å¯å®šä½æœåŠ¡å¹¶å…è®¸æƒé™ã€‚\néšç§æ•°æ®å°†åœ¨å½’è¿˜åæ°¸ä¹…åˆ é™¤ã€‚");

        // å®šä½ç¡®è®¤
        if (!confirm("è¯·ç¡®è®¤å·²å¼€å¯æ‰‹æœºå®šä½æœåŠ¡ï¼Œç‚¹å‡»ç¡®å®šç»§ç»­ã€‚")) {
            alert("å®šä½æœåŠ¡æœªå¼€å¯ï¼Œè¯·å¼€å¯ååˆ·æ–°é¡µé¢ã€‚");
            throw new Error("å®šä½æœåŠ¡æœªå¼€å¯");
        }

        // è·å–ä½ç½®å’Œåœ°å€
        async function getLocationAndAddress() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('è·å–ä½ç½®è¶…æ—¶'));
                }, 20000);

                AMap.plugin(['AMap.Geolocation', 'AMap.Geocoder'], function() {
                    const geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,
                        timeout: 10000
                    });

                    geolocation.getCurrentPosition(function(status, result) {
                        clearTimeout(timeout);
                        if (status === 'complete') {
                            const position = result.position;
                            const locationStr = `çº¬åº¦: ${position.lat}, ç»åº¦: ${position.lng}`;
                            
                            const geocoder = new AMap.Geocoder();
                            geocoder.getAddress(position, function(status, result) {
                                if (status === 'complete' && result.regeocode) {
                                    const address = result.regeocode.formattedAddress;
                                    resolve({ location: locationStr, address: address });
                                } else {
                                    reject(new Error('è·å–åœ°å€å¤±è´¥'));
                                }
                            });
                        } else {
                            reject(new Error('è·å–ä½ç½®å¤±è´¥'));
                        }
                    });
                });
            });
        }

        // å‘é€åˆ°ä¼ä¸šå¾®ä¿¡æœºå™¨äºº - å¢å¼ºé”™è¯¯å¤„ç†
        async function sendToWeCom(message) {
            const webhookUrl = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=a74bfe660b4747069179abad196d071c"; // æ›¿æ¢ä¸ºå®é™…æœºå™¨äººkey
            
            try {
                // æ£€æŸ¥æ˜¯å¦ä¸ºHTTPSç¯å¢ƒ
                if (window.location.protocol !== 'https:') {
                    throw new Error('è¯·åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨æœ¬åŠŸèƒ½');
                }
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(message),
                    // å¢åŠ è¶…æ—¶è®¾ç½®
                    signal: AbortSignal.timeout(15000)
                });
                
                const responseText = await response.text();
                
                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} - ${responseText}`);
                }
                
                // æ£€æŸ¥ä¼ä¸šå¾®ä¿¡è¿”å›çš„é”™è¯¯ç 
                try {
                    const result = JSON.parse(responseText);
                    if (result.errcode !== 0) {
                        throw new Error(`ä¼ä¸šå¾®ä¿¡æ¥å£é”™è¯¯: ${result.errmsg}`);
                    }
                } catch (e) {
                    if (!(e instanceof Error)) {
                        throw new Error('è§£ææ¥å£å“åº”å¤±è´¥');
                    }
                    throw e;
                }
                
                return { success: true };
            } catch (error) {
                console.error('å‘é€åˆ°ä¼ä¸šå¾®ä¿¡å¤±è´¥:', error);
                return { 
                    success: false, 
                    error: error.message,
                    type: error.name === 'AbortError' ? 'timeout' : 
                          error.message.includes('HTTPS') ? 'protocol' : 'network'
                };
            }
        }

        // æäº¤å¤„ç†
        document.getElementById('submit-btn').addEventListener('click', async function() {
            const btn = this;
            const errorElement = document.getElementById('error-message');
            
            // é‡ç½®é”™è¯¯ä¿¡æ¯
            errorElement.style.display = 'none';
            errorElement.textContent = '';
            
            btn.disabled = true;
            btn.textContent = "å¤„ç†ä¸­...";

            try {
                const itemName = document.getElementById('item-name').value;
                if (!itemName) {
                    alert("è¯·è¾“å…¥å¤±ç‰©åç§°");
                    return;
                }
                
                const finderName = document.getElementById('finder-name').value || 'åŒ¿å';
                const finderPhone = document.getElementById('finder-phone').value;

                const { location, address } = await getLocationAndAddress();
                document.getElementById('user-location').textContent = location;
                document.getElementById('user-address').textContent = address;
                document.getElementById('location-info').style.display = 'block';

                // ä½¿ç”¨å¯¹è±¡ç»“æ„æ„å»ºæ¶ˆæ¯ï¼Œé¿å…ä½¿ç”¨+å·æ‹¼æ¥
                const message = {
                    "msgtype": "markdown",
                    "markdown": {
                        "content": [
                            "**ã€å¤±ç‰©æ‹›é¢†é€šçŸ¥ã€‘**\n\n",
                            "ğŸ” å¤±ç‰©åç§°ï¼š<font color=\"info\">", itemName, "</font>\n\n",
                            "ğŸ‘¤ æ‹¾å–è€…ï¼š<font color=\"comment\">", finderName, "</font>\n\n",
                            "ğŸ“ è”ç³»ç”µè¯ï¼š<font color=\"comment\">", finderPhone || 'æœªæä¾›', "</font>\n\n",
                            "ğŸ“ ç»çº¬åº¦ï¼š<font color=\"comment\">", location, "</font>\n\n",
                            "ğŸ  è¯¦ç»†åœ°å€ï¼š<font color=\"comment\">", address, "</font>\n\n",
                            "â° æäº¤æ—¶é—´ï¼š<font color=\"comment\">", new Date().toLocaleString(), "</font>\n\n",
                            "> âš ï¸ è¯·å¤±ä¸»å°½å¿«è”ç³»æ‹¾å–è€…ï¼Œéšç§æ•°æ®å°†åœ¨å½’è¿˜åæ°¸ä¹…åˆ é™¤"
                        ].join('')
                    }
                };

                const result = await sendToWeCom(message);
                if (result.success) {
                    alert("ä¿¡æ¯å·²æäº¤ï¼Œè¯·åŠæ—¶è”ç³»å¤±ä¸»ï¼");
                } else {
                    // æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
                    errorElement.textContent = `æäº¤å¤±è´¥: ${result.error}\n`;
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›è§£å†³æ–¹æ¡ˆ
                    if (result.type === 'protocol') {
                        errorElement.textContent += "è§£å†³æ–¹æ¡ˆ: è¯·å°†ç½‘ç«™éƒ¨ç½²åˆ°HTTPSç¯å¢ƒ";
                    } else if (result.type === 'timeout') {
                        errorElement.textContent += "è§£å†³æ–¹æ¡ˆ: ç½‘ç»œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•";
                    } else {
                        errorElement.textContent += "è§£å†³æ–¹æ¡ˆ: è¯·æ£€æŸ¥ä¼ä¸šå¾®ä¿¡æœºå™¨äººé…ç½®æˆ–æ‰‹åŠ¨è”ç³»å¤±ä¸»";
                    }
                    
                    errorElement.style.display = 'block';
                    alert("ä¿¡æ¯æäº¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹é”™è¯¯æç¤º");
                }
            } catch (error) {
                console.error('å¤„ç†å¤±è´¥:', error);
                alert("è·å–ä½ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æœåŠ¡å¹¶é‡è¯•ã€‚");
            } finally {
                btn.disabled = false;
                btn.textContent = "æäº¤ä½ç½®ä¿¡æ¯";
            }
        });
    </script>
</body>
</html>